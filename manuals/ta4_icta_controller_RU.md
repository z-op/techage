# Контроллер TA4 ICTA

Контроллер ICTA (ICTA означает «If Condition Then Action» — «Если условие, то действие») используется для мониторинга и управления машинами. С помощью контроллера можно считывать данные с машин и других блоков и в зависимости от этого включать/выключать другие машины и блоки.

## 8 правил контроллера

Контроллер работает на основе правил, при этом на одном контроллере можно создать до 8 правил.

Примеры правил:
- Если распределитель заблокирован (`blocked`), следует отключить толкатель перед ним.
- Если машина находится в состоянии неисправности (`fault`), следует включить сигнальную лампу.
- Если игрок находится рядом с детектором игроков, его имя должно отображаться на дисплее.
- Если датчик тележек обнаруживает тележку, её следует загрузить (включить толкатель).

Все правила должны выполняться только так часто, насколько это необходимо. Это даёт два преимущества:
- Батарея контроллера служит дольше (для каждого контроллера требуется батарея).
- Нагрузка на сервер снижается (меньше лагов).

## Циклическое выполнение правил

Эти правила циклически проверяются контроллером. Если условие (`condition`) выполняется, выполняется соответствующее действие (`action`). Пока условие не выполняется — ничего не происходит. Даже если условие уже было выполнено при предыдущей проверке правила и действие уже было выполнено, повторного действия не последует. Условие должно сначала стать **ложным**, а затем снова **истинным**, чтобы действие выполнилось повторно.

Частота проверки правила контроллером может быть настроена индивидуально для каждого правила. Для этого необходимо указать время цикла в секундах (`Cycle/s`) — значение от 1 до 1000.

## Событийно-управляемое выполнение правил

В качестве альтернативы циклической проверке правил существует событийно-управляемое выполнение.

События — это команды, отправляемые другими блоками контроллеру. Примеры: датчики и переключатели. Они отправляют команды `on` / `off`. Например, при включении переключатель отправляет команду `on`, а при выключении — команду `off` на блок с номером, заданным в настройках переключателя.

Для правил, которые должны выполняться по событию, необходимо указать время цикла **0**.

## Время задержки

Для каждого действия необходимо задать время задержки (`after/s`). Если действие должно быть выполнено немедленно, укажите **0**.

## Условия / Conditions

Для каждого правила можно настроить одно из следующих условий. На одно правило можно назначить только **одно** условие.

- `initial` — Условие всегда выполняется сразу после включения контроллера. Используется, например, для выключения лампы, чтобы затем включить её при возникновении ошибки.
- `true` — Условие всегда истинно. Используется, например, для создания мигающей лампы. Для этого требуются два правила. Например, если оба правила имеют цикл 2 с, но первое имеет задержку 0 с, а второе — 1 с, то лампа будет циклически включаться и выключаться.
- `condition` — Позволяет запустить действие в зависимости от другого правила. Необходимо указать номер другого правила (1–8). Таким образом, с помощью одного условия можно реализовать два действия. Дополнительно можно использовать параметр `was not true`, чтобы, например, выключить лампу, когда условие больше не выполняется.
- `inputs` — Позволяет обрабатывать полученное значение команды (`on` / `off`). **Важно:** для событийно-управляемых правил необходимо указать время цикла **0**.
- `read block state` — Позволяет запросить состояние машины. Необходимо указать номер блока. Возможные состояния машины:
  - `running` → Машина работает.
  - `stopped` → Машина выключена.
  - `standby` → Машина простаивает (например, инвентарь пуст).
  - `blocked` → Машина заблокирована (например, выходной инвентарь полон).
  - `fault` → Машина в состоянии ошибки. Дополнительную информацию можно найти в меню машины.
  - `unloaded` → Машина была выгружена сервером из-за удалённости (без блока принудительной загрузки). Такая машина неактивна.

Если настроенное условие выполняется (например, «блок №456 остановлен»), выполняется действие.

> **Информация:** Номер блока — это уникальное число, генерируемое Techage при размещении большинства блоков Techage. Он отображается в виде информационного текста после названия блока. Номер блока используется для адресации при взаимодействии между контроллерами Techage и машинами.  
> Какие именно состояния предоставляет конкретная машина, проще всего узнать с помощью гаечного ключа / инструмента «Techage Info», наведя его на машину.

- `read amount of fuel` — Позволяет считать количество топлива в машине (обычно от 0 до 99 единиц) и сравнить его со значением на «больше» или «меньше». Если условие выполняется — действие запускается.
- `read power/liquid load` — Позволяет запросить уровень заряда аккумулятора или теплового накопителя в процентах (0–100) и сравнить с заданным значением на «больше»/«меньше». При выполнении условия — действие выполняется.
- `read delivered power` — Позволяет запросить мощность, выдаваемую генератором (в ку). Значение можно сравнить на «больше»/«меньше». Если условие выполняется — действие выполняется.  
  > **Примечание:** Аккумуляторы могут как отдавать, так и принимать энергию. Поэтому при зарядке этот показатель будет **отрицательным**.
- `read chest state` — Позволяет запросить состояние сундука TA3/TA4. Возможные состояния:
  - `empty` — Сундук пуст.
  - `loaded` — Сундук частично заполнен.
  - `full` — Все слоты сундука хотя бы частично заняты.
  
  При выполнении условия — действие выполняется.

- `read Signal Tower state` — Позволяет запросить цвет сигнальной вышки. Возможные значения: `off`, `green`, `amber`, `red`. При совпадении — действие выполняется.
- `read Player Detector` — Позволяет запросить данные детектора игроков. Детектор возвращает имя игрока, находящегося рядом.  
  - Чтобы выводилось **любое** имя игрока, укажите `*` в поле «player name(s)».
  - Можно указать несколько имён, разделив их пробелами.
  - Чтобы действие выполнялось, **когда игроков рядом нет**, укажите `-`.

## Действия / Actions

Для всех действий, управляющих блоками (например, лампой), необходимо указать **номер блока**. На одно правило можно назначить только **одно** действие.

- `print to output window` — Вывод текста в окно вывода контроллера (вкладка «outp»). Полезно для тестирования и отладки.
- `send Signal Tower command` — Установка цвета сигнальной вышки. Возможные значения: `off`, `green`, `amber`, `red`.
- `turn block off/on` — Включение или выключение блока/машины.
- `Display: overwrite one line` — Вывод текста на дисплей. Необходимо указать номер строки (1–5).  
  Чтобы вывести имя игрока из условия, в поле «text» укажите символ `*`.
- `Display: Clear screen` — Очистка экрана дисплея.
- `send chat message` — Отправка сообщения в чат игроку.
- `open/close door` — Открытие/закрытие стандартных дверей. Поскольку у дверей нет номеров, необходимо указать их координаты. Координаты легко определить с помощью гаечного ключа / инструмента «Techage Info».
- `turn Distributor filter on/off` — Включение/выключение фильтров (выходов) распределителя. Необходимо указать нужный выход по **цвету**.

## Прочее

- Контроллер содержит встроенную справку и подсказки по всем командам, доступные через его меню.
- Считывание данных с машин и управление блоками осуществляется через так называемые **команды**. Для понимания принципов работы команд рекомендуется ознакомиться с главой **TA3 → Логические/управляющие блоки** в справке внутри игры (Construction Plan).
- Справка также доступна в формате PDF для печати или офлайн-чтения:  
  https://github.com/joe7575/techage/blob/master/manuals/ta4_icta_controller_DE.pdf
